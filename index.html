<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Felipe Canneli - 3D Acid Chat Overlay</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent !important; 
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* Filtro de Saturação Y2K */
        .hyper-filter {
            position: fixed;
            inset: 0;
            pointer-events: none;
            backdrop-filter: saturate(2.3) contrast(1.2);
            z-index: 5;
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div class="hyper-filter"></div>

    <script>
        let scene, camera, renderer, clock;
        const chatBlocks = [];
        const maxMessages = 6;
        const channel = 'felipecanneli';

        // Mensagens Ácidas de Arranque (Sem ser cringe)
        const acidPhrases = [
            { user: "STATUS", msg: "SILÊNCIO, O ARTISTA ESTÁ EXAUSTO" },
            { user: "DESCULPA", msg: "FUI BUSCAR O BANHEIRO, JÁ VOLTO" },
            { user: "DESCULPA", msg: "FUI USAR A PIPOCA" },
            { user: "SISTEMA", msg: "ESTADO MENTAL: CHERNOBYL" },
            { user: "AVISO", msg: "FUI ALI ME CANCELAR E JÁ VOLTO" }
        ];

        function init() {
            scene = new THREE.Scene();

            // Câmara posicionada para o canto inferior esquerdo
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(-20, -10, 80); 

            renderer = new THREE.WebGLRenderer({ 
                canvas: document.getElementById('bg-canvas'), 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setClearColor(0x000000, 0); 
            
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.6; 

            clock = new THREE.Clock();

            // Iluminação para realçar o 3D das placas
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);

            const keyLight = new THREE.PointLight(0xffffff, 2, 200);
            keyLight.position.set(20, 20, 60);
            scene.add(keyLight);

            const neonLight = new THREE.PointLight(0x39ff14, 3, 100);
            neonLight.position.set(-40, -10, 30);
            scene.add(neonLight);

            connectTwitchChat();
            
            // Inserir frases ácidas iniciais
            acidPhrases.forEach((m, i) => {
                setTimeout(() => addChatBlock(m.user, m.msg), i * 1200);
            });

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createRoundedRectShape(width, height, radius) {
            const shape = new THREE.Shape();
            const x = -width / 2;
            const y = -height / 2;
            shape.moveTo(x, y + radius);
            shape.lineTo(x, y + height - radius);
            shape.quadraticCurveTo(x, y + height, x + radius, y + height);
            shape.lineTo(x + width - radius, y + height);
            shape.quadraticCurveTo(x + width, y + height, x + width, y + height - radius);
            shape.lineTo(x + width, y + radius);
            shape.quadraticCurveTo(x + width, y, x + width - radius, y);
            shape.lineTo(x + radius, y);
            shape.quadraticCurveTo(x, y, x, y + radius);
            return shape;
        }

        function createChatTexture(user, message) {
            const canvas = document.createElement('canvas');
            canvas.width = 1024;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');

            // Fundo da Placa (Laranja Ácido)
            ctx.fillStyle = '#ff4500'; 
            ctx.beginPath();
            ctx.roundRect(15, 15, 994, 226, 60);
            ctx.fill();

            // Borda Branca Grossa (Estilo Adesivo)
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 20;
            ctx.stroke();

            // Nome do Utilizador (Verde Neon)
            ctx.fillStyle = '#39ff14';
            ctx.font = 'bold 36px Arial Black, sans-serif';
            ctx.fillText(user.toUpperCase(), 60, 85);

            // Mensagem (Preto Puro para legibilidade)
            ctx.fillStyle = '#000000';
            ctx.font = '900 48px Arial Black, sans-serif';
            
            // Sombra do Texto
            ctx.shadowColor = 'rgba(255, 255, 255, 0.4)';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 4;
            ctx.shadowOffsetY = 4;

            const words = message.split(' ');
            let line = '';
            let y = 160;
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > 850 && n > 0) {
                    ctx.fillText(line, 60, y);
                    line = words[n] + ' ';
                    y += 55;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, 60, y);

            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            return texture;
        }

        function addChatBlock(user, message) {
            const texture = createChatTexture(user, message);
            
            // Dimensões reduzidas para não tapar a tela (35x10)
            const shape = createRoundedRectShape(35, 10, 2.5);
            const extrudeSettings = { depth: 2, bevelEnabled: true, bevelThickness: 0.3, bevelSize: 0.3, bevelSegments: 3 };
            const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            
            const chromeMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                metalness: 1, 
                roughness: 0.1
            });
            
            const faceMat = new THREE.MeshStandardMaterial({ map: texture, transparent: true });
            
            const mesh = new THREE.Mesh(geometry, [faceMat, chromeMat]);
            
            // Posicionamento no canto inferior esquerdo
            mesh.position.set(-60, -35, 0); 
            mesh.rotation.y = 0.15;
            
            scene.add(mesh);
            
            const blockObj = {
                mesh: mesh,
                targetY: -28,
                targetX: -28, 
                offset: Math.random() * Math.PI
            };

            chatBlocks.push(blockObj);

            // Subir os blocos antigos (Empilhamento)
            for(let i = 0; i < chatBlocks.length - 1; i++) {
                chatBlocks[i].targetY += 12;
            }

            if (chatBlocks.length > maxMessages) {
                const old = chatBlocks.shift();
                scene.remove(old.mesh);
            }

            setTimeout(() => {
                const idx = chatBlocks.indexOf(blockObj);
                if(idx > -1) {
                    scene.remove(blockObj.mesh);
                    chatBlocks.splice(idx, 1);
                }
            }, 30000);
        }

        function connectTwitchChat() {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
            socket.onopen = () => {
                socket.send('PASS SCHMOOPIIE');
                socket.send('NICK justinfan' + Math.floor(Math.random() * 10000));
                socket.send('JOIN #' + channel);
            };
            socket.onmessage = (event) => {
                const message = event.data;
                if (message.includes('PRIVMSG')) {
                    const parts = message.split('PRIVMSG #' + channel + ' :');
                    const user = message.split('!')[0].substring(1);
                    const chatMsg = parts[1];
                    addChatBlock(user, chatMsg);
                }
                if (message.includes('PING :tmi.twitch.tv')) socket.send('PONG :tmi.twitch.tv');
            };
            socket.onclose = () => setTimeout(connectTwitchChat, 3000);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            chatBlocks.forEach((block) => {
                block.mesh.position.y += (block.targetY - block.mesh.position.y) * 0.1;
                block.mesh.position.x += (block.targetX - block.mesh.position.x) * 0.1;
                
                // Balanço suave
                block.mesh.position.x += Math.sin(time + block.offset) * 0.03;
                block.mesh.rotation.x = Math.sin(time * 0.5 + block.offset) * 0.02;
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.onload = init;
    </script>
</body>
</html>
